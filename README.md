# 設計書

## 概要

### 背景・目的

背景：スプレッドシートのタスクを手作業でMicrosoft To Doへ転記するのは手間であった。

目的：スプレッドシートのタスクを自動でMicrosoft To Doに連携し、転記作業を省力化・効率化する。

### 機能一覧

* Googleスプレッドシートの「Tasks」シートに記載されたタスクをMicrosoft To Doへ自動で登録します。
* MicrosoftアカウントのOAuth2認証フロー（認証URL生成・認可コード入力・トークン取得）を実行できます。
* アクセストークンの有効期限を管理し、期限切れ時は自動でリフレッシュします。
* タスクごとに登録結果（成功またはエラー内容）を「result」列に出力します。
* タイトルやリスト名などの必須項目をバリデーションします。
* 期限日、リマインダー、本文、繰り返し設定など各種タスク属性を反映して登録します。
* Googleスプレッドシートのカスタムメニューから認証やタスク登録などの操作を実行できます。

## 入力（Googleスプレッドシート構成）

本スクリプトは、以下2つのシート構成を前提としています。

### 「Auth」シート

| セル | 内容 |
| ---- | ---- |
| A1   | MicrosoftアプリのClient ID |
| A2   | MicrosoftアプリのClient Secret |
| A3   | Authorization Code |
| A4   | アクセストークン（自動取得・更新） |
| A5   | リフレッシュトークン（自動取得・更新） |
| A6   | 認証URL（自動生成） |
| A7   | トークン有効期限（自動生成、UNIXミリ秒、内部管理用） |

### 「Tasks」シート

| 列名         | 内容                         |
| ------------ | ---------------------------- |
| title        | タスクのタイトル（必須）     |
| list_name    | 登録先リスト名（必須）       |
| body         | タスクの本文（任意）         |
| due          | 期限日  |
| reminder     | リマインダー日時             |
| status       | タスクの状態（任意、未指定時はnotStarted） |
| recurrence_type  | 繰り返し種別（任意、未指定時は繰り返しなし） |
| recurrence_start | 繰り返し開始日（任意）        |
| recurrence_end   | 繰り返し終了日（任意）        |
| recurrence_interval | 繰り返し間隔（任意、数値） |
| result       | 登録結果（自動出力）         |

#### status列に指定可能な値

| 値                | 意味         |
|-------------------|--------------|
| notStarted        | 未開始       |
| inProgress        | 進行中       |
| completed         | 完了         |
| waitingOnOthers   | 他者待ち     |
| deferred          | 延期         |

#### recurrence_type列に指定可能な値

| 値         | 意味         |
|------------|--------------|
| daily      | 毎日         |
| weekly     | 毎週         |
| absoluteMonthly | 毎月（特定日） |
| absoluteYearly  | 毎年（特定日） |
| relativeMonthly | 毎月（第n曜日など） |
| relativeYearly  | 毎年（第n曜日など） |

## 出力

* Googleスプレッドシート「Tasks」シートの「result」列に、各タスクの登録結果（Successまたはエラー内容）を自動で出力します。
* Microsoft To Doに、Tasksシートで指定した内容のタスクが登録されます。
* Googleスプレッドシート上で、処理完了やエラー発生時にダイアログメッセージが表示されます。

※ ファイルとしての出力（CSVやPDFなど）はありません。

## 実行方法

1. Googleスプレッドシートを開き、「拡張機能」→「Apps Script」から本スクリプト（MicrosoftToDoImporter.gs）を貼り付けて保存します。
2. スプレッドシートに「Auth」シートと「Tasks」シートを作成し、必要なセル・列を準備します。
3. 「Auth」シートのA1・A2セルにMicrosoftアプリのClient ID・Client Secretを入力します。
4. スプレッドシートを再読み込みし、メニューに「Microsoft To Do」が追加されていることを確認します。
5. メニューから「認証URL生成」を選択し、A6セルのURLをブラウザで開いて認可コードを取得します。
6. 認可コードをA3セルに貼り付け、「トークン取得」を実行してアクセストークンを取得します。
7. 「Tasks」シートにタスク情報を記入し、「TasksシートからTo Doに登録」を実行します。
8. 各タスクの登録結果が「result」列に出力されます。

## 想定実行環境

本ツールはGoogle Apps Script（GAS）として動作します。利用にあたり、以下の環境を想定しています。

| 項目 | 内容 |
| ---- | ---- |
| 動作環境 | Googleスプレッドシート（Webブラウザー版） |
| ブラウザ | Google Chrome最新版 |
| Microsoftアカウント | Microsoft To Doが利用可能なアカウント（組織/個人どちらも可） |

## 処理詳細

本ツールの主な処理フローは以下の通りです。

### 認証URL生成処理

Googleスプレッドシートのカスタムメニューから「認証URL生成」を選択すると、次の処理を行います。

1. AuthシートA1セルからMicrosoftアプリのClient IDを取得します。
2. Microsoft認証エンドポイント、リダイレクトURI、スコープなどのパラメータを組み合わせて認証用URLを生成します。
3. 生成した認証URLをAuthシートA6セルに出力します。

A6セルのURLをブラウザで開き、Microsoftアカウントで認可を行い、表示された認可コードをAuthシートA3セルに貼り付けてください。

### トークン取得処理

Googleスプレッドシートのカスタムメニューから「トークン取得」を選択すると、次の処理を行います。

1. AuthシートA1セルからClient ID、A2セルからClient Secret、A3セルから認可コードを取得します。
2. 取得した情報をもとに、Microsoftのトークンエンドポイント（/token）へアクセストークン・リフレッシュトークン取得リクエストを送信します。
3. レスポンスからアクセストークン・リフレッシュトークン・有効期限を取得します。
4. 取得したアクセストークンをAuthシートA4セル、リフレッシュトークンをA5セル、有効期限（UNIXミリ秒換算）をA7セルに保存します。

### タスク登録処理

Googleスプレッドシートのカスタムメニューから「TasksシートからTo Doに登録」を選択すると、次の処理を行います。

1. Tasksシートの全データ行を取得し、1行ずつ順に処理します。
2. 各行について、以下の処理を実施します。
   1. タスクデータをオブジェクト形式に変換します。
   2. 必須項目（タイトル・リスト名）が未入力の場合はバリデーションエラーとしてresult列にエラー内容を出力し、次の行へ進みます。
   3. 期限日やリマインダー、繰り返し設定などの値を整形・検証します（不正な場合はエラーとしてresult列に出力）。
   4. Microsoft To DoリストIDをAPI経由で取得します（リストが存在しない場合はエラーとしてresult列に出力）。
   5. タスク情報をMicrosoft Graph API用のリクエスト形式に変換します。
   6. Microsoft Graph APIを呼び出してタスクを登録します。
   7. 登録に成功した場合はresult列に「Success」、失敗した場合はエラー内容を出力します。

## メッセージ一覧

| 種別 | メッセージ内容 | 用途・タイミング |
| ---- | ------------- | --------------- |
| 完了 | 認証URLを生成しました。\nセルA6をクリックしてブラウザで開いてください。 | 認証URL生成時（ダイアログ） |
| 完了 | アクセストークンとリフレッシュトークンを取得しました。 | トークン取得成功時（ダイアログ） |
| 完了 | タスク登録処理が完了しました！ | 全タスク登録完了時（ダイアログ） |
| 結果 | Success | タスク登録成功時（result列） |
| 結果 | Error: {msg} | タスク登録失敗時（result列） |
| エラー | {sheetName}シートが存在しません | Authシートが存在しない場合 |
| エラー | {sheetName}シートが存在しません | Authシートが存在しない場合 |
| エラー | A3セルにAuthorization Codeを入力してください。 | 認可コード未入力でトークン取得時 |
| エラー | Authシートにトークン情報がありません。初回認証が必要です。 | トークン未取得時 |
| エラー | トークン取得リクエストに失敗しました: {msg} | トークン取得APIエラー時 |
| エラー | アクセストークン取得に失敗しました: {msg} | アクセストークン取得失敗時 |
| エラー | Tasksシートに'result'列がありません。'result'列を追加してください。 | result列未作成時 |
| エラー | title/list_name missing | 必須項目未入力時 |
| エラー | due日付が不正です | 期限日が不正な場合 |
| エラー | reminder日付が不正です | リマインダー日付が不正な場合 |
| エラー | 指定リストが見つかりません: {listName} | list_name不正時 |
| エラー | {sheetName}シートが存在しません | Tasksシートが存在しない場合 |

## ライセンス

### 本プログラムのライセンス

* このプログラムはMITライセンスに基づいて提供されます。

## 開発詳細

### 開発環境

* VSCode バージョン 1.102.3

## 改訂履歴

| バージョン | 日付 | 内容 |
| ----- | ---------- | -------------- |
| 1.0.0 | 2025-08-17 | 初版リリース |
